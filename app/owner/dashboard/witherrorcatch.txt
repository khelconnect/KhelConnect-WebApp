"use client"

import { useEffect, useState, useMemo, useCallback } from "react"
import { useRouter } from "next/navigation"
import { supabase } from "@/lib/supabaseClient"
import { Button } from "@/components/ui/button"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { Clock, Users, Plus, Trash2, Loader2, AlertTriangle } from "lucide-react"
import { Calendar } from "@/components/ui/calendar"
import { format } from "date-fns"
import { Badge } from "@/components/ui/badge"
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog"
import { Label } from "@/components/ui/label"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { Input } from "@/components/ui/input"
import { cn } from "@/lib/utils"

// --- TYPES ---
type TimeSlotDisplay = {
  id: string
  time: string
}

type BookingType = {
  id: string
  date: string
  slot: string
  slotId: string
  customerName: string
  customerPhone: string
  customerEmail: string
  sport: string
  price: number
  status: "confirmed" | "pending" | "cancelled"
  source: "app" | "manual"
}

type ManualBlockType = {
  id: string
  date: string
  slot: string
  slotId: string
  reason: string
}

type OwnerType = {
  id: string
  name: string
  turf_name: string
}

type TurfType = {
  id: string
  name: string
}

// --- HELPER COMPONENT for Loading/Error ---
function DashboardNotice({ message, isError = false }: { message: string, isError?: boolean }) {
  console.log(`%c[RENDER] DashboardNotice: ${isError ? 'ERROR' : 'LOADING'} - ${message}`, isError ? 'color: red' : 'color: blue');
  return (
    <div className="flex flex-col items-center justify-center min-h-[400px] text-center p-6">
      {isError ? (
        <AlertTriangle className="h-12 w-12 text-destructive mb-4" />
      ) : (
        <Loader2 className="h-12 w-12 animate-spin text-primary mb-4" />
      )}
      <h3 className="text-xl font-semibold mb-2">{isError ? "An Error Occurred" : "Loading Dashboard"}</h3>
      <p className="text-muted-foreground max-w-md">{message}</p>
    </div>
  )
}

// --- MAIN COMPONENT ---
export default function OwnerDashboardPage() {
  console.log('%c[RENDER] OwnerDashboardPage component rendered', 'color: green');
  const router = useRouter()
  
  // --- STATE ---
  const [activeTab, setActiveTab] = useState("bookings")
  const [selectedDate, setSelectedDate] = useState<Date>(new Date())
  const [owner, setOwner] = useState<OwnerType | null>(null)
  const [turf, setTurf] = useState<TurfType | null>(null)
  const [timeSlots, setTimeSlots] = useState<TimeSlotDisplay[]>([])
  const [bookings, setBookings] =useState<BookingType[]>([])
  const [manualBlocks, setManualBlocks] = useState<ManualBlockType[]>([])
  const [isInitializing, setIsInitializing] = useState(true)
  const [isBookingsLoading, setIsBookingsLoading] = useState(false)
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [pageError, setPageError] = useState<string | null>(null)
  const [isBookingModalOpen, setIsBookingModalOpen] = useState(false)
  const [isBlockModalOpen, setIsBlockModalOpen] = useState(false)
  const [newBooking, setNewBooking] = useState({
    customerName: "", customerPhone: "", customerEmail: "",
    sport: "football", slotId: "", price: "",
  })
  const [newBlock, setNewBlock] = useState({ slotId: "", reason: "" })

  // --- DATA FETCHING ---

  /**
   * EFFECT 1: Initialize Dashboard (Owner, Turf, TimeSlots)
   */
  useEffect(() => {
    const initializeDashboard = async () => {
      console.log('%c[EFFECT 1] initializeDashboard START', 'color: blue; font-weight: bold;');
      setIsInitializing(true)
      setPageError(null)

      try {
        const ownerId = localStorage.getItem("owner_id")
        console.log('[EFFECT 1] Fetched ownerId from localStorage:', ownerId);
        if (!ownerId) {
          console.warn('[EFFECT 1] No ownerId found. Redirecting to login.');
          router.push("/owner/login")
          return
        }

        console.log('[EFFECT 1] Fetching Owner/Turf and TimeSlots in parallel...');
        const [ownerResult, slotsResult] = await Promise.all([
          supabase.from("turf_owners").select("*, turfs (id, name)").eq("id", ownerId).single(),
          supabase.from("time_slots").select("id, start_time, period").order("start_time")
        ])

        console.log('[EFFECT 1] RAW ownerResult:', ownerResult);
        console.log('[EFFECT 1] RAW slotsResult:', slotsResult);

        // --- Process Owner/Turf Result ---
        if (ownerResult.error || !ownerResult.data) {
          throw new Error(`Failed to fetch owner details. Check RLS on 'turf_owners' and 'turfs' tables. DB Error: ${JSON.stringify(ownerResult.error)}`)
        }
        console.log('[EFFECT 1] PROCESSED ownerData:', ownerResult.data);
        setOwner(ownerResult.data)
        
        const ownerTurfs = ownerResult.data.turfs
        if (Array.isArray(ownerTurfs) && ownerTurfs.length > 0) {
          console.log('[EFFECT 1] PROCESSED turfData:', ownerTurfs[0]);
          setTurf(ownerTurfs[0])
        } else {
          throw new Error("No turf is associated with this owner account in the 'turfs' table.")
        }

        // --- Process TimeSlots Result ---
        if (slotsResult.error || !slotsResult.data) {
          throw new Error(`Failed to fetch time slots. Check RLS on 'time_slots' table. DB Error: ${JSON.stringify(slotsResult.error)}`)
        }
        const formattedSlots = slotsResult.data.map((slot) => ({
          id: slot.id,
          time: `${slot.start_time}${slot.period ? ` ${slot.period}` : ""}`,
        }))
        console.log('[EFFECT 1] PROCESSED formattedSlots:', formattedSlots);
        setTimeSlots(formattedSlots)

      } catch (error: any) {
        console.error('%c[EFFECT 1] CATCH ERROR', 'color: red; font-weight: bold;', error.message);
        setPageError(error.message)
      } finally {
        console.log('%c[EFFECT 1] initializeDashboard END', 'color: blue; font-weight: bold;');
        setIsInitializing(false)
      }
    }

    initializeDashboard()
  }, [router])

  /**
   * EFFECT 2: Fetch Bookings
   */
  useEffect(() => {
    const fetchBookingsForDate = async () => {
      console.log('%c[EFFECT 2] fetchBookingsForDate START', 'color: purple; font-weight: bold;');
      
      if (isInitializing) {
        console.log('[EFFECT 2] Aborted: Still initializing.');
        return;
      }
      if (!turf) {
        console.log('[EFFECT 2] Aborted: Turf is null.');
        return;
      }
      if (timeSlots.length === 0) {
        console.log('[EFFECT 2] Aborted: TimeSlots are empty.');
        return;
      }

      setIsBookingsLoading(true)
      setPageError(null)
      const formattedDate = format(selectedDate, "yyyy-MM-dd")
      console.log(`[EFFECT 2] Fetching bookings for turfId: ${turf.id} on date: ${formattedDate}`);

      try {
        const { data, error } = await supabase
          .from("bookings")
          .select("*, users (name, phone, email)")
          .eq("turf_id", turf.id)
          .eq("date", formattedDate)

        console.log('[EFFECT 2] RAW bookings data:', data);
        console.log('[EFFECT 2] RAW bookings error:', error);

        if (error) {
          throw new Error(`Failed to fetch bookings. Check RLS on 'bookings' and 'users' tables. DB Error: ${JSON.stringify(error)}`)
        }

        const newBookings: BookingType[] = []
        const newBlocks: ManualBlockType[] = []

        data.forEach((b) => {
          const slotId = b.slot[0]
          const timeSlot = timeSlots.find(ts => ts.id === slotId)
          const displayTime = timeSlot ? timeSlot.time : "Unknown Slot"
          
          if (b.status === "blocked") {
            newBlocks.push({
              id: b.id, date: b.date, slot: displayTime, slotId: slotId,
              reason: b.sport,
            })
          } else {
            newBookings.push({
              id: b.id, date: b.date, slot: displayTime, slotId: slotId,
              customerName: b.users?.name || "N/A",
              customerPhone: b.users?.phone || "N/A",
              customerEmail: b.users?.email || "N/A",
              sport: b.sport,
              price: b.amount,
              status: b.status as any,
              source: b.user_id ? "app" : "manual",
            })
          }
        })

        console.log('[EFFECT 2] PROCESSED newBookings:', newBookings);
        console.log('[EFFECT 2] PROCESSED newBlocks:', newBlocks);
        setBookings(newBookings)
        setManualBlocks(newBlocks)

      } catch (error: any) {
        console.error('%c[EFFECT 2] CATCH ERROR', 'color: red; font-weight: bold;', error.message);
        setPageError(error.message)
      } finally {
        console.log('%c[EFFECT 2] fetchBookingsForDate END', 'color: purple; font-weight: bold;');
        setIsBookingsLoading(false)
      }
    }

    fetchBookingsForDate()
  }, [selectedDate, turf, timeSlots, isInitializing])


  // --- DERIVED STATE & MEMOS ---
  const totalRevenue = useMemo(() => {
    console.log('[MEMO] Calculating totalRevenue');
    return bookings.reduce(
      (sum, booking) =>
        booking.status === "confirmed" ? sum + booking.price : sum,
      0
    )
  }, [bookings])

  const isSlotTaken = useCallback((slotId: string) => {
    console.log(`[CALLBACK] Checking isSlotTaken for slotId: ${slotId}`);
    return (
      bookings.some((b) => b.slotId === slotId) ||
      manualBlocks.some((b) => b.slotId === slotId)
    )
  }, [bookings, manualBlocks])

  // --- CRUD HANDLERS ---
  const handleAddBooking = async () => {
    console.log('%c[HANDLER] handleAddBooking START', 'color: orange; font-weight: bold;');
    console.log('[HANDLER] newBooking state:', newBooking);
    
    if (!newBooking.customerName || !newBooking.customerPhone || !newBooking.slotId || !newBooking.sport || !newBooking.price || !turf) {
      alert("Please fill all required fields")
      console.warn('[HANDLER] AddBooking validation failed.');
      return
    }

    setIsSubmitting(true)
    try {
      // 1. Upsert User
      console.log('[HANDLER] 1. Upserting user...');
      const { data: userData, error: userError } = await supabase
        .from("users")
        .upsert({
          name: newBooking.customerName,
          phone: newBooking.customerPhone,
          email: newBooking.customerEmail || null,
        }, { onConflict: "phone" })
        .select("id")
        .single()
      
      console.log('[HANDLER] 1. RAW user upsert result:', { userData, userError });
      if (userError) throw userError

      // 2. Insert Booking
      console.log('[HANDLER] 2. Inserting booking...');
      const { data: bookingData, error: bookingError } = await supabase
        .from("bookings")
        .insert({
          turf_id: turf.id,
          date: format(selectedDate, "yyyy-MM-dd"),
          slot: [newBooking.slotId],
          user_id: userData.id,
          status: "confirmed",
          payment_status: "pending",
          amount: Number(newBooking.price),
          sport: newBooking.sport,
        })
        .select("*, users (name, phone, email)")
        .single()

      console.log('[HANDLER] 2. RAW booking insert result:', { bookingData, bookingError });
      if (bookingError) throw bookingError

      // 3. Update UI
      console.log('[HANDLER] 3. Updating UI state...');
      const timeSlot = timeSlots.find(ts => ts.id === bookingData.slot[0])
      const addedBooking: BookingType = {
        id: bookingData.id, date: bookingData.date,
        slot: timeSlot ? timeSlot.time : "Unknown",
        slotId: bookingData.slot[0],
        customerName: bookingData.users?.name || "N/A",
        customerPhone: bookingData.users?.phone || "N/A",
        customerEmail: bookingData.users?.email || "N/A",
        sport: bookingData.sport, price: bookingData.amount,
        status: bookingData.status as any, source: "manual",
      }
      console.log('[HANDLER] 3. PROCESSED addedBooking:', addedBooking);
      setBookings(prev => [...prev, addedBooking])
      
      // 4. Reset Form
      console.log('[HANDLER] 4. Resetting form and closing modal.');
      setNewBooking({ customerName: "", customerPhone: "", customerEmail: "", sport: "football", slotId: "", price: "" })
      setIsBookingModalOpen(false)
    } catch (error: any) {
      console.error('%c[HANDLER] CATCH ERROR handleAddBooking', 'color: red; font-weight: bold;', error);
      alert(`Error: ${error.message || JSON.stringify(error)}`)
    } finally {
      console.log('%c[HANDLER] handleAddBooking END', 'color: orange; font-weight: bold;');
      setIsSubmitting(false)
    }
  }

  const handleAddBlock = async () => {
    console.log('%c[HANDLER] handleAddBlock START', 'color: orange; font-weight: bold;');
    console.log('[HANDLER] newBlock state:', newBlock);

    if (!newBlock.slotId || !newBlock.reason || !turf) {
      alert("Please fill all required fields")
      console.warn('[HANDLER] AddBlock validation failed.');
      return
    }

    setIsSubmitting(true)
    try {
      console.log('[HANDLER] 1. Inserting block (as booking)...');
      const { data: blockData, error: blockError } = await supabase
        .from("bookings")
        .insert({
          turf_id: turf.id,
          date: format(selectedDate, "yyyy-MM-dd"),
          slot: [newBlock.slotId],
          user_id: null,
          status: "blocked",
          payment_status: "n/a",
          amount: 0,
          sport: newBlock.reason,
        })
        .select()
        .single()
      
      console.log('[HANDLER] 1. RAW block insert result:', { blockData, blockError });
      if (blockError) throw blockError

      // Update UI
      console.log('[HANDLER] 2. Updating UI state...');
      const timeSlot = timeSlots.find(ts => ts.id === blockData.slot[0])
      const addedBlock: ManualBlockType = {
        id: blockData.id, date: blockData.date,
        slot: timeSlot ? timeSlot.time : "Unknown",
        slotId: blockData.slot[0],
        reason: blockData.sport,
      }
      console.log('[HANDLER] 2. PROCESSED addedBlock:', addedBlock);
      setManualBlocks(prev => [...prev, addedBlock])

      // Reset Form
      console.log('[HANDLER] 3. Resetting form and closing modal.');
      setNewBlock({ slotId: "", reason: "" })
      setIsBlockModalOpen(false)
    } catch (error: any) {
      console.error('%c[HANDLER] CATCH ERROR handleAddBlock', 'color: red; font-weight: bold;', error);
      alert(`Error: ${error.message || JSON.stringify(error)}`)
    } finally {
      console.log('%c[HANDLER] handleAddBlock END', 'color: orange; font-weight: bold;');
      setIsSubmitting(false)
    }
  }

  const handleDeleteBooking = async (id: string) => {
    console.log(`%c[HANDLER] handleDeleteBooking START for id: ${id}`, 'color: orange; font-weight: bold;');
    if (!confirm("Are you sure you want to delete this booking?")) return
    const oldBookings = bookings
    setBookings(bookings.filter((b) => b.id !== id))
    const { error } = await supabase.from("bookings").delete().eq("id", id)
    if (error) {
      console.error('%c[HANDLER] CATCH ERROR handleDeleteBooking', 'color: red; font-weight: bold;', error);
      alert("Failed to delete booking.")
      setBookings(oldBookings) // Revert on error
    } else {
      console.log(`[HANDLER] Successfully deleted booking id: ${id}`);
    }
  }

  const handleDeleteBlock = async (id: string) => {
    console.log(`%c[HANDLER] handleDeleteBlock START for id: ${id}`, 'color: orange; font-weight: bold;');
    if (!confirm("Are you sure you want to unblock this slot?")) return
    const oldBlocks = manualBlocks
    setManualBlocks(manualBlocks.filter((b) => b.id !== id))
    const { error } = await supabase.from("bookings").delete().eq("id", id)
    if (error) {
      console.error('%c[HANDLER] CATCH ERROR handleDeleteBlock', 'color: red; font-weight: bold;', error);
      alert("Failed to delete block.")
      setManualBlocks(oldBlocks) // Revert on error
    } else {
      console.log(`[HANDLER] Successfully deleted block id: ${id}`);
    }
  }

  const handleSignOut = () => {
    console.log('%c[HANDLER] handleSignOut', 'color: orange; font-weight: bold;');
    localStorage.removeItem("owner_id")
    router.push("/owner/login")
  }

  // --- RENDER LOGIC ---

  // 1. Handle Initializing State
  if (isInitializing) {
    console.log('%c[RENDER] Displaying Initializing Loader', 'color: green;');
    return <DashboardNotice message="Loading your dashboard, turf, and time slots..." />
  }

  // 2. Handle Page-Stopping Errors (e.g., RLS)
  if (pageError && !turf) {
    console.log('%c[RENDER] Displaying Page-Stopping Error', 'color: red; font-weight: bold;');
    return <DashboardNotice message={pageError} isError />
  }

  // 3. Render Dashboard
  console.log('%c[RENDER] Displaying Main Dashboard', 'color: green; font-weight: bold;');
  return (
    <div className="space-y-8">
      {/* Header */}
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h1 className="text-3xl font-bold mb-2">Turf Owner Dashboard</h1>
          <p className="text-muted-foreground">
            Manage bookings for <span className="font-medium text-primary">{turf?.name || "Your Turf"}</span>
          </p>
        </div>
        <Button variant="outline" className="gap-2" onClick={handleSignOut}>
          Sign Out
        </Button>
      </div>

      {/* Stats Cards */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <Card className="bg-card border-border rounded-xl">
          <CardHeader className="pb-2">
            <CardTitle className="text-lg">Today's Bookings</CardTitle>
            <CardDescription>{bookings.length} booking{bookings.length !== 1 && "s"} today</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold text-primary">{bookings.length}</div>
          </CardContent>
        </Card>
        <Card className="bg-card border-border rounded-xl">
          <CardHeader className="pb-2">
            <CardTitle className="text-lg">Blocked Slots</CardTitle>
            <CardDescription>{manualBlocks.length} slot{manualBlocks.length !== 1 && "s"} blocked</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold text-primary">{manualBlocks.length}</div>
          </CardContent>
        </Card>
        <Card className="bg-card border-border rounded-xl">
          <CardHeader className="pb-2">
            <CardTitle className="text-lg">Total Revenue Today</CardTitle>
            <CardDescription>From all confirmed bookings</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold text-primary">₹{totalRevenue}</div>
          </CardContent>
        </Card>
      </div>

      {/* Main Content Grid */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
        {/* Calendar */}
        <Card className="bg-card border-border rounded-xl md:col-span-1">
          <CardHeader>
            <CardTitle className="text-lg">Select Date</CardTitle>
          </CardHeader>
          <CardContent>
            <Calendar
              mode="single"
              selected={selectedDate}
              onSelect={(date) => {
                console.log('[EVENT] Date selected:', date);
                date && setSelectedDate(date)
              }}
              className="rounded-md border-border"
            />
          </CardContent>
        </Card>

        {/* Schedule Tabs */}
        <Card className="bg-card border-border rounded-xl md:col-span-3">
          <CardHeader>
            <CardTitle className="text-lg">
              Schedule for {format(selectedDate, "EEEE, MMMM d, yyyy")}
            </CardTitle>
          </CardHeader>
          <CardContent>
            <Tabs value={activeTab} onValueChange={(value) => {
              console.log(`[EVENT] Tab changed to: ${value}`);
              setActiveTab(value);
            }}>
              <TabsList className="mb-6">
                <TabsTrigger value="bookings" className="flex items-center gap-2">
                  <Users className="h-4 w-4" /> Bookings
                </TabsTrigger>
                <TabsTrigger value="availability" className="flex items-center gap-2">
                  <Clock className="h-4 w-4" /> Availability
                </TabsTrigger>
              </TabsList>

              {/* Display error *inside* the tab content if one occurs */}
              {pageError && (
                <div className="mb-4">
                  <DashboardNotice message={pageError} isError />
                </div>
              )}

              {/* Bookings Tab */}
              <TabsContent value="bookings" className="space-y-6">
                <div className="flex justify-between items-center">
                  <h3 className="text-lg font-medium">Bookings</h3>
                  <Dialog open={isBookingModalOpen} onOpenChange={setIsBookingModalOpen}>
                    <DialogTrigger asChild>
                      <Button className="bg-primary hover:bg-mint-dark text-white gap-2">
                        <Plus className="h-4 w-4" /> Add Manual Booking
                      </Button>
                    </DialogTrigger>
                    <DialogContent className="sm:max-w-md bg-card border-border">
                      <DialogHeader><DialogTitle>Add Manual Booking</DialogTitle></DialogHeader>
                      <div className="space-y-4 py-4">
                        {/* Add Booking Form Fields */}
                        <div className="space-y-2">
                          <Label htmlFor="customerName">Customer Name*</Label>
                          <Input id="customerName" value={newBooking.customerName} onChange={(e) => setNewBooking({ ...newBooking, customerName: e.target.value })} />
                        </div>
                        <div className="space-y-2">
                          <Label htmlFor="customerPhone">Phone Number*</Label>
                          <Input id="customerPhone" value={newBooking.customerPhone} onChange={(e) => setNewBooking({ ...newBooking, customerPhone: e.target.value })} />
                        </div>
                        <div className="space-y-2">
                          <Label htmlFor="customerEmail">Email (Optional)</Label>
                          <Input id="customerEmail" value={newBooking.customerEmail} onChange={(e) => setNewBooking({ ...newBooking, customerEmail: e.target.value })} />
                        </div>
                        <div className="space-y-2">
                          <Label htmlFor="sport">Sport*</Label>
                          <Select value={newBooking.sport} onValueChange={(value) => setNewBooking({ ...newBooking, sport: value })}>
                            <SelectTrigger><SelectValue placeholder="Select sport" /></SelectTrigger>
                            <SelectContent>
                              <SelectItem value="football">football</SelectItem>
                              <SelectItem value="cricket">Cricket</SelectItem>
                              {/* Add other sports */}
                            </SelectContent>
                          </Select>
                        </div>
                        <div className="space-y-2">
                          <Label htmlFor="slot">Time Slot*</Label>
                          <Select value={newBooking.slotId} onValueChange={(value) => setNewBooking({ ...newBooking, slotId: value })}>
                            <SelectTrigger><SelectValue placeholder="Select time slot" /></SelectTrigger>
                            <SelectContent>
                              {timeSlots.map((slot) => (
                                <SelectItem key={slot.id} value={slot.id} disabled={isSlotTaken(slot.id)}>
                                  {slot.time} {isSlotTaken(slot.id) && "(Unavailable)"}
                                </SelectItem>
                              ))}
                            </SelectContent>
                          </Select>
                        </div>
                        <div className="space-y-2">
                          <Label htmlFor="price">Price (₹)*</Label>
                          <Input id="price" value={newBooking.price} type="number" onChange={(e) => setNewBooking({ ...newBooking, price: e.target.value })} />
                        </div>
                        <Button onClick={handleAddBooking} className="w-full" disabled={isSubmitting}>
                          {isSubmitting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : "Add Booking"}
                        </Button>
                      </div>
                    </DialogContent>
                  </Dialog>
                </div>

                {isBookingsLoading ? (
                  <div className="flex justify-center py-12"><Loader2 className="h-8 w-8 animate-spin text-primary" /></div>
                ) : bookings.length === 0 ? (
                  <div className="text-center py-12 text-muted-foreground">No bookings for this date.</div>
                ) : (
                  <div className="space-y-4">
                    {bookings.map((booking) => (
                      <Card key={booking.id} className="bg-secondary border-border">
                        <CardContent className="p-4">
                          <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div className="flex items-start gap-4">
                              <div className="bg-primary/10 p-3 rounded-full"><Clock className="h-5 w-5 text-primary" /></div>
                              <div>
                                <div className="flex items-center gap-2">
                                  <h4 className="font-medium">{booking.slot}</h4>
                                  <Badge variant={booking.source === "app" ? "default" : "outline"} className={cn("text-xs", booking.source === "app" ? "bg-primary text-white" : "bg-secondary text-primary border-primary")}>
                                    {booking.source === "app" ? "App Booking" : "Manual Entry"}
                                  </Badge>
                                </div>
                                <p className="text-sm text-muted-foreground">{booking.customerName} • {booking.customerPhone}</p>
                                <p className="text-sm text-muted-foreground">{booking.sport} • ₹{booking.price}</p>
                              </div>
                            </div>
                            <div className="flex items-center gap-2 ml-auto">
                              <Button variant="ghost" size="icon" className="text-destructive hover:text-destructive hover:bg-destructive/10" onClick={() => handleDeleteBooking(booking.id)}>
                                <Trash2 className="h-4 w-4" />
                              </Button>
                            </div>
                          </div>
                        </CardContent>
                      </Card>
                    ))}
                  </div>
                )}
              </TabsContent>

              {/* Availability Tab */}
              <TabsContent value="availability" className="space-y-6">
                <div className="flex justify-between items-center">
                  <h3 className="text-lg font-medium">Blocked Slots</h3>
                  <Dialog open={isBlockModalOpen} onOpenChange={setIsBlockModalOpen}>
                    <DialogTrigger asChild>
                      <Button className="bg-primary hover:bg-mint-dark text-white gap-2">
                        <Plus className="h-4 w-4" /> Block Slot
                      </Button>
                    </DialogTrigger>
                    <DialogContent className="sm:max-w-md bg-card border-border">
                      <DialogHeader><DialogTitle>Block Time Slot</DialogTitle></DialogHeader>
                      <div className="space-y-4 py-4">
                        <div className="space-y-2">
                          <Label htmlFor="slot-block">Time Slot*</Label>
                          <Select value={newBlock.slotId} onValueChange={(value) => setNewBlock({ ...newBlock, slotId: value })}>
                            <SelectTrigger id="slot-block"><SelectValue placeholder="Select time slot" /></SelectTrigger>
                            <SelectContent>
                              {timeSlots.map((slot) => (
                                <SelectItem key={slot.id} value={slot.id} disabled={isSlotTaken(slot.id)}>
                                  {slot.time} {isSlotTaken(slot.id) && "(Unavailable)"}
                                </SelectItem>
                              ))}
                            </SelectContent>
                          </Select>
                        </div>
                        <div className="space-y-2">
                          <Label htmlFor="reason">Reason*</Label>
                          <Input id="reason" value={newBlock.reason} onChange={(e) => setNewBlock({ ...newBlock, reason: e.target.value })} placeholder="e.g., Maintenance" />
                        </div>
                        <Button onClick={handleAddBlock} className="w-full" disabled={isSubmitting}>
                          {isSubmitting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : "Block Slot"}
                        </Button>
                      </div>
                    </DialogContent>
                  </Dialog>
                </div>

                {isBookingsLoading ? (
                  <div className="flex justify-center py-12"><Loader2 className="h-8 w-8 animate-spin text-primary" /></div>
                ) : (
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {timeSlots.map((slot) => {
                      const booking = bookings.find((b) => b.slotId === slot.id)
                      const block = manualBlocks.find((b) => b.slotId === slot.id)
                      const isAvailable = !booking && !block
                      return (
                        <Card key={slot.id} className={cn("border", isAvailable ? "bg-secondary/50" : booking ? "bg-primary/10 border-primary/30" : "bg-destructive/10 border-destructive/30")}>
                          <CardContent className="p-4">
                            <div className="flex justify-between items-center">
                              <div>
                                <p className="font-medium">{slot.time}</p>
                                <p className="text-sm text-muted-foreground">
                                  {isAvailable ? "Available" : booking ? `Booked: ${booking.customerName}` : `Blocked: ${block?.reason}`}
                                </p>
                              </div>
                              {block && (
                                <Button variant="ghost" size="icon" className="text-destructive hover:text-destructive hover:bg-destructive/10" onClick={() => handleDeleteBlock(block.id)}>
                                  <Trash2 className="h-4 w-4" />
                                </Button>
                              )}
                            </div>
                          </CardContent>
                        </Card>
                      )
                    })}
                  </div>
                )}
              </TabsContent>
            </Tabs>
          </CardContent>
        </Card>
      </div>
    </div>
  )
}